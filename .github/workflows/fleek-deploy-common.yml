name: ⚡️ Deploy site (Common)

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string

jobs:
  deploy-to-fleek:
    runs-on: ubuntu-latest
    environment: staging
    env:
      FLEEK_TOKEN: ${{ secrets.FLEEK_TOKEN }}
      FLEEK_PROJECT_ID: ${{ secrets.FLEEK_PROJECT_ID }}
      DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: ./.github/actions/setup-nodejs

      - name: Install Doppler CLI
        uses: dopplerhq/cli-action@v3

      - name: Setup Doppler
        run: |
          doppler configure set token ${{ secrets.DOPPLER_TOKEN }}
          doppler configure set project ${{ secrets.DOPPLER_PROJECT }}
          doppler configure set config ${{ secrets.DOPPLER_CONFIG }}

      - name: Env vars health check
        run: |
          if ! doppler run -- printenv | grep -q 'NEXT_PUBLIC_SDK__AUTHENTICATION_URL'; then
            echo "👹 Oops! Missing required environment variable during health check..."
            exit 1           
          fi

          echo "🚑 Doppler envVars seem healthy!"

      - name: Setup dotenv
        run: |
          targetEnvPath=".env"
          # Using dotenv due to `fleek sites deploy`
          # failing to authenticate via the host or declared
          # fleek env vars for some reason
          doppler secrets download \
            --no-file \
            --format env > "$targetEnvPath"

          # The Fleek CLI supports envVars overrides
          # for this reason, we should exclude some vars
          # originated from doppler
          EXCLUDE_CSV="UI__APP_URL,SDK__GRAPHQL_API_URL,SDK__AUTH_APPS_URL,SDK__IPFS__STORAGE_API_URL,SDK__UPLOAD_PROXY_API_URL"

          for item in "${EXCLUDE_ARRAY[@]}"; do
            sed -i "/$item/d" "$targetEnvPath"
          done

          for item in "${EXCLUDE_ARRAY[@]}"; do
            if grep -q "$item" "$targetEnvPath"; then
              echo "👹 Oops! Failed to exclude variables from $targetEnvPath for some reason..."
              exit 1
            fi
          done

          echo "✅ Completed dot env setup!"

      - name: Install Fleek CLI
        run: pnpm i -g @fleek-platform/cli

      - name: Install Packages
        run: pnpm install

      - name: Build & deploy
        run: |
          fleek sites deploy

      - name: Clear
        run: |
          rm .env
