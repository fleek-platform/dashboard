name: ðŸ’ Tester runner

on:
  workflow_dispatch:
  push:

jobs:
  build:
    # On CI/CD runners, low specs cause inconsistent runs
    # To mitigate any inconsistency playwright's team
    # recommends running in a single worker
    # https://playwright.dev/docs/ci#workers
    # Note: That launching a `macos-latest-xlarge`
    # is more efficient but increases cost dramatically
    runs-on: macos-latest-large
    continue-on-error: false
    env:
      # TODO: For testing CI/CD only, should be to settings
      NEXT_PUBLIC_SDK__AUTHENTICATION_URL: "https://graphql.service.staging.fleeksandbox.xyz/graphql"
      NEXT_PUBLIC_UI_FLEEK_REST_API_URL: "https://api.staging.fleeksandbox.xyz"
      NEXT_PUBLIC_UI__DYNAMIC_ENVIRONMENT_ID: "c4d4ccad-9460-419c-9ca3-494488f8c892"
      NEXT_PUBLIC_UI__FEEDBACK_FISH_PROJECT_ID: "ece374513b4e20"
      NEXT_PUBLIC_UI__GTM_ID: "GTM-5RC2N5H"
      NEXT_PUBLIC_UI__LAUNCH_DARKLY_CLIENT_ID: "65c3a5a6319ed30fd0b640a4"
      NEXT_PUBLIC_UI__LOG_ROCKET_ID: "0pggxb/stg-kr0yz"
      NEXT_PUBLIC_UI__POSTHOG_HOST: "https://us.i.posthog.com"
      NEXT_PUBLIC_UI__POSTHOG_KEY: "phc_trRjv1UAiR7m8JkbV3gA6hJdrl2nUjme1cVDmQCnAZ4"
      NEXT_PUBLIC_UI__SITE_SLUG_DOMAIN: "stg.on-fleek-test.app"
      NEXT_PUBLIC_UI__STRIPE_PUBLIC_KEY: "pk_test_CJZoF6F9uT47IWH2gtdoxvOn"
      NEXT_PUBLIC_UI__WEB3AUTH_CLIENT_ID: "BKqrNFQNjQpRlWBgt7OA3S6P1MTP3ispI1lXR48cl6xW6bwFBNRH0Smuw83hp_cT_rUFo1OJvgQD0R8ZQD85ybQ"
      NEXT_PUBLIC_UI__ZENDESK_PROXY_API: "https://support-prod-eu-lon-1-01.flkservices.io"
      NEXT_PUBLIC_ZENDESK_PROXY_HOSTNAME: "support-prod-eu-lon-1-01.flkservices.io"
      NEXT_PUBLIC_UI__UPLOAD_PROXY_API_URL: "https://uploads.service.staging.fleeksandbox.xyz"
      NEXT_PUBLIC_UI__INTERNAL_IPFS_STORAGE_HOSTNAME: "storage-ipfs.internal.staging.fleeksandbox.xyz"
      NEXT_DEV_SERVER_PORT: 3001
      NEXT_PUBLIC_TEST_MODE: 1
      NODE_ENV: 'development'
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Help reduce number of executions for cost saving
      # due to need of large runners, e.g. `macos-latest-large`
      - name: Local test run checkup
        run: |
          if ! .scripts/has_local_test_run; then
            echo "ðŸ‘¹ Oops! Seems that local tests haven't been run. Please run tests locally and commit any changes before pushing."
            exit 1
          fi

          echo "âœ… Local tests were run!"

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        
      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 9
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - uses: actions/cache@v4
        name: Setup pnpm cache
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install
        run: pnpm i

      - name: Install Playwright Browsers
        run: pnpm exec playwright install --with-deps

      - name: Start development server in background
        run: |
          pnpm dev &
          .scripts/await_dev_server "$NEXT_DEV_SERVER_PORT"

      - name: Run tests
        env:
          PLAYWRIGHT_WORKERS: 2
        run: |
          pnpm test
