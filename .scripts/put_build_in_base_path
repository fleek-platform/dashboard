#!/bin/bash

echo "üë∑ Put build in base path (if required)..."

if [[ -z "$NEXT_PUBLIC_DASHBOARD_BASE_PATH" && -z "$CI" ]]; then
  echo "ü¶ñ Skipping build static files due to be running outside CI. The dev server should suggest the address with base path for you!"

  exit 0
fi

outputDir="out"
outputBakDir="$outputDir.bak"
outputWithBaseDir="$outputDir/$NEXT_PUBLIC_DASHBOARD_BASE_PATH"
indexForRedirectBaseDir="$outputDir/index.html"
indexForMainApp="$outputDir/$NEXT_PUBLIC_DASHBOARD_BASE_PATH/index.html"
redirectsFilepath="public/_redirects"

if [[ -n "$NEXT_PUBLIC_DASHBOARD_BASE_PATH" && "$NEXT_PUBLIC_DASHBOARD_BASE_PATH" != '/' ]]; then
  echo "ü§ñ Must copy files to base path $NEXT_PUBLIC_DASHBOARD_BASE_PATH..."
  
  mv "$outputDir" "$outputBakDir"
  mkdir -p "$outputWithBaseDir"

  if ! cp -r "$outputBakDir"/* "$outputWithBaseDir"; then
    echo "üëπ Oops! Failed to copy $outputDir to $outputWithBaseDir for some reason..."
    exit 1
  else
    echo "‚úÖ Copied output files to $outputWithBaseDir"
  fi

  echo "ü§ñ Copy redirects file to root"
  cp "$redirectsFilepath" "$outputDir"

  echo "<html><head><script>window.location.href=\"$NEXT_PUBLIC_DASHBOARD_BASE_PATH\";</script></head></html>" > "$indexForRedirectBaseDir"
fi

echo
echo "üëç Put build in base path completed!"
