#!/bin/bash

# Required vars (shared)
source .scripts/test_runner_vars

outputDir="out"
outputBakDir="$outputDir.bak"
outputWithBaseDir="$outputDir/$NEXT_PUBLIC_DASHBOARD_BASE_PATH"
indexForRedirectBaseDir="$outputDir/index.html"

echo "ğŸ‘· Build Static site..."

echo "ğŸ¤– Run next build..."

if ! next build; then
  echo "ğŸ‘¹ Oops! Nextjs build failed"
  exit 1
fi

if [[ ! -z "$NEXT_PUBLIC_DASHBOARD_BASE_PATH" ]]; then
  mv "$outputDir" "$outputBakDir"
  mkdir -p "$outputWithBaseDir"

  if ! cp -r "$outputBakDir/" "$outputWithBaseDir"; then
    echo "ğŸ‘¹ Oops! Failed to copy $outputDir to $outputWithBaseDir for some reason..."
    exit 1
  fi

  echo "<html><head><script>window.location.href=\"$NEXT_PUBLIC_DASHBOARD_BASE_PATH\";</script></head></html>" > "$indexForRedirectBaseDir"
fi

echo "ğŸ¤– Generate sitemap..."
if ! pnpm run generate:sitemap; then
  echo "ğŸ‘¹ Oops! Sitemap generator failure"
  exit 1
fi

echo "ğŸ¤– Copy public assets to $build_out_path"
if ! cp -r public/* "$build_out_path"; then
  echo "ğŸ‘¹Oops! Failed to copy public assets to distribution directory"
  exit 1
fi

.scripts/test_run_hash_signature > "$build_hash_path"

echo
echo "ğŸ‘ Static site builder completed!"
